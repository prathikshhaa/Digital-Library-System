<!DOCTYPE html>
<html>
<head>
    <title>Borrowed Books</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .delete-icon {
            cursor: pointer;
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-left: 0; /* No extra spacing */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1>Borrowed Books List</h1>
        <table border="1" cellpadding="10">
            <thead>
                <tr>
                    <th>User Name</th>
                    <th>User Email</th>
                    <th>Book Title</th>
                    <th>Borrow Date</th>
                    <th>Return Date</th>
                </tr>
            </thead>
            <tbody id="borrowedBooksTable">
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        function formatDate(dateTimeString) {
            if (!dateTimeString) return 'Not returned yet';
            const date = new Date(dateTimeString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        async function fetchBorrowedBooks() {
            const res = await fetch('/borrowed-books/data');
            const data = await res.json();

            const tableBody = document.getElementById('borrowedBooksTable');
            tableBody.innerHTML = '';

            data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.user_name}</td>
                    <td>${record.user_email}</td>
                    <td>${record.book_title}</td>
                    <td>${formatDate(record.borrow_date)}</td>
                    <td>
                        ${record.return_date ? 
                            `${formatDate(record.return_date)} 
                            <img src="/uploads/dustbin.png" class="delete-icon" title="Delete record" onclick="deleteRecord(${record.id}, this)">` 
                            : 'Not returned yet'
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function deleteRecord(id, iconElement) {
            const confirmDelete = confirm('Are you sure you want to delete this record?');
            if (!confirmDelete) return;

            const res = await fetch(`/borrowed-books/delete/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                const row = iconElement.closest('tr');
                row.remove();
                alert('Record deleted successfully');
            } else {
                alert('Failed to delete record');
            }
        }

        window.onload = fetchBorrowedBooks;
    </script>
</body>
</html>
